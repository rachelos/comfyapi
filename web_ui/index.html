<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI API é›†æˆç¤ºä¾‹</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #f9fafb;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --border-radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f8fafc;
        }
        
        h1, h2 {
            color: var(--text-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        h1 {
            font-size: 2.25rem;
            text-align: center;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h2 {
            font-size: 1.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        
        pre {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            border-left: 4px solid var(--primary-color);
            margin: 1rem 0;
        }
        
        code {
            font-family: 'Cascadia Code', Consolas, Monaco, 'Andale Mono', monospace;
        }
        
        .example-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 30px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        label {
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin: 5px 10px 5px 0;
            font-weight: 500;
            font-size: 1rem;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #cancel-btn {
            background-color: #ef4444;
        }
        
        #cancel-btn:hover {
            background-color: #dc2626;
        }
        
        #test-btn {
            background-color: #f59e0b;
        }
        
        #test-btn:hover {
            background-color: #d97706;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            margin: 20px 0;
            height: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #8b5cf6);
            border-radius: 9999px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status {
            margin: 15px 0;
            font-size: 0.95rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }
        
        .result-container {
            margin-top: 30px;
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        img {
            max-width: 100%;
            border-radius: var(--border-radius);
            display: none;
            box-shadow: var(--shadow);
        }
        
        #no-image-text {
            text-align: center;
            padding: 30px;
            color: #6b7280;
            font-style: italic;
        }
        
        #image-info-content {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        /* æ–°å¢æ ·å¼ */
        header {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            flex: 1;
            min-width: 120px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .label-icon, .btn-icon {
            margin-right: 6px;
            display: inline-block;
        }
        
        @media (max-width: 600px) {
            .form-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ComfyUI å›¾åƒç”Ÿæˆå·¥å…·</h1>
    </header>
    
    <div class="example-container">
        <h2>åˆ›å»ºæ‚¨çš„AIè‰ºæœ¯</h2>
        
        <div class="form-group">
            <label for="workflow">
                <span class="label-icon">ğŸ“‹</span>
                é€‰æ‹©æµç¨‹:
            </label>
            <select id="workflow" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; margin-top: 5px; margin-bottom: 15px;">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="prompt">
                <span class="label-icon">âœ¨</span>
                æç¤ºè¯:
            </label>
            <input type="text" id="prompt" value="ä¸€åªå¯çˆ±çš„çŒ«å’ªï¼Œé«˜æ¸…ç…§ç‰‡" placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾åƒ...">
        </div>
        
        <div class="form-group">
            <label for="negative-prompt">
                <span class="label-icon">â›”</span>
                è´Ÿé¢æç¤ºè¯:
            </label>
            <input type="text" id="negative-prompt" value="æ¨¡ç³Š, ä½è´¨é‡" placeholder="æè¿°æ‚¨æƒ³è¦é¿å…çš„å…ƒç´ ...">
        </div>
        
        <div class="form-controls">
            <div class="control-group">
                <label for="width">
                    <span class="label-icon">â†”ï¸</span>
                    å®½åº¦:
                </label>
                <input type="number" id="width" value="640" min="64" max="2048">
            </div>
            <div class="control-group">
                <label for="height">
                    <span class="label-icon">â†•ï¸</span>
                    é«˜åº¦:
                </label>
                <input type="number" id="height" value="480" min="64" max="2048">
            </div>
            <div class="control-group">
                <label for="batch_size">
                    <span class="label-icon">ğŸ”¢</span>
                    æ•°é‡:
                </label>
                <input type="number" id="batch_size" value="2" min="1" max="4">
            </div>
        </div>
        
        <div class="button-group">
            <button id="generate-btn">
                <span class="btn-icon">ğŸ¨</span>
                ç”Ÿæˆå›¾åƒ
            </button>
            <button id="cancel-btn" disabled>
                <span class="btn-icon">ğŸ›‘</span>
                å–æ¶ˆç”Ÿæˆ
            </button>
            <button id="test-btn">
                <span class="btn-icon">ğŸ”</span>
                æ£€æµ‹
            </button>
        </div>
        
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <div id="status-display" class="status">å‡†å¤‡å°±ç»ª</div>
        
        <div class="result-container">
            <img id="result-image" alt="ç”Ÿæˆçš„å›¾åƒ">
            <div id="no-image-text">å°šæœªç”Ÿæˆå›¾åƒ</div>
            <pre id="image-info-content"></pre>
        </div>
    </div>

    <!-- å¼•å…¥ ComfyUI API -->
    <script src="script.js"></script>
    
    <script>
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        // è·å–æµç¨‹æ•°æ®çš„å‡½æ•°
        async function fetchWorkflows() {
            try {
                const workflowSelect = document.getElementById('workflow');
                workflowSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                
                const response = await fetch('/api/workflows');
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const workflows = await response.json();
                
                // æ¸…ç©ºä¸‹æ‹‰æ¡†
                workflowSelect.innerHTML = '';
                
                // æ·»åŠ é»˜è®¤é€‰é¡¹
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- è¯·é€‰æ‹©æµç¨‹ --';
                workflowSelect.appendChild(defaultOption);
                
                // æ·»åŠ æµç¨‹é€‰é¡¹
                workflows.forEach((workflow, index) => {
                    const option = document.createElement('option');
                    option.value = workflow.path ||"";
                    option.textContent = workflow.name || `æµç¨‹ ${option.value}`;
                    workflowSelect.appendChild(option);
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•ˆé€‰é¡¹
                    if (index === 0) {
                        workflowSelect.value = option.value;
                    }
                });
                
                console.log(`æˆåŠŸåŠ è½½ ${workflows.length} ä¸ªæµç¨‹`);
                
                // å¦‚æœæ²¡æœ‰æµç¨‹æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                if (workflows.length === 0) {
                    workflowSelect.innerHTML = '<option value="">æ²¡æœ‰å¯ç”¨æµç¨‹</option>';
                }
            } catch (error) {
                console.error('è·å–æµç¨‹æ•°æ®å¤±è´¥:', error);
                const workflowSelect = document.getElementById('workflow');
                workflowSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½æµç¨‹æ•°æ®
            fetchWorkflows();
            
            // ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
            console.log("Load ComfyUI API")
            // é…ç½® ComfyUI çš„å›è°ƒå‡½æ•°
            ComfyUI.init({
                apiBasePath: '/api',
                statusCheckInterval: 1000,
                onStatusChange: (status, taskId, data) => {
                    console.log(`ä»»åŠ¡çŠ¶æ€å˜æ›´: ${status}`);
                    document.getElementById('status-display').textContent = `çŠ¶æ€: ${status}`;
                },
                onProgress: (progress, data) => {
                    console.log(`è¿›åº¦: ${progress }%`);
                    document.getElementById('progress-bar').style.width = `${progress}%`;
                },
                onComplete: (imageUrls, promptId, taskId) => {
                    console.log('å›¾åƒç”Ÿæˆå®Œæˆï¼Œè¿”å›æ•°æ®:', imageUrls);
                    console.log('å›¾åƒç±»å‹:', typeof imageUrls, Array.isArray(imageUrls) ? 'æ˜¯æ•°ç»„' : 'éæ•°ç»„');
                    
                    // æ£€æŸ¥å›¾åƒURLæ˜¯å¦æœ‰æ•ˆ
                    if (Array.isArray(imageUrls)) {
                        imageUrls.forEach((url, index) => {
                            console.log(`å›¾åƒ ${index + 1} URL:`, url);
                        });
                    } else if (imageUrls) {
                        console.log('å•å¼ å›¾åƒ URL:', imageUrls);
                    } else {
                        console.error('æœªæ”¶åˆ°æœ‰æ•ˆçš„å›¾åƒURL');
                    }
                    
                    // åˆ›å»ºæˆ–æ¸…ç©ºå›¾åƒå®¹å™¨
                    let imageContainer = document.getElementById('image-container');
                    if (!imageContainer) {
                        imageContainer = document.createElement('div');
                        imageContainer.id = 'image-container';
                        imageContainer.style.display = 'flex';
                        imageContainer.style.flexWrap = 'wrap';
                        imageContainer.style.gap = '10px';
                        imageContainer.style.justifyContent = 'center';
                        imageContainer.style.marginBottom = '15px';
                        
                        // å°†å®¹å™¨æ’å…¥åˆ°ç»“æœå®¹å™¨çš„å¼€å¤´
                        const resultContainer = document.querySelector('.result-container');
                        resultContainer.insertBefore(imageContainer, resultContainer.firstChild);
                        
                        // éšè—åŸå§‹å›¾åƒå…ƒç´ 
                        const resultImage = document.getElementById('result-image');
                        resultImage.style.display = 'none';
                    } else {
                        console.log('æ¸…ç©ºç°æœ‰å›¾åƒå®¹å™¨');
                        imageContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
                    }
                    
                    console.log('å‡†å¤‡æ˜¾ç¤ºå›¾åƒï¼Œæ•°é‡:', Array.isArray(imageUrls) ? imageUrls.length : 1);
                    
                    // éšè—æç¤ºæ–‡æœ¬
                    document.getElementById('no-image-text').style.display = 'none';
                    
                    // å¾ªç¯æ˜¾ç¤ºæ‰€æœ‰å›¾åƒ
                    if (Array.isArray(imageUrls)) {
                        imageUrls.forEach((imageUrl, index) => {
                            // åˆ›å»ºæ–°çš„å›¾åƒå…ƒç´ 
                            const imgElement = document.createElement('img');
                            imgElement.src = imageUrl;
                            imgElement.alt = `ç”Ÿæˆå›¾åƒ ${index + 1}`;
                            imgElement.style.maxWidth = '100%';
                            imgElement.style.height = 'auto';
                            imgElement.style.margin = '10px';
                            imgElement.style.borderRadius = '8px';
                            imgElement.style.display = 'block'; // ç¡®ä¿å›¾åƒæ˜¾ç¤º
                            imgElement.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                            imgElement.style.transition = 'transform 0.3s ease';
                            
                            // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                            imgElement.onmouseover = () => {
                                imgElement.style.transform = 'scale(1.02)';
                            };
                            imgElement.onmouseout = () => {
                                imgElement.style.transform = 'scale(1)';
                            };
                            
                            // æ·»åŠ å›¾åƒåŠ è½½äº‹ä»¶å¤„ç†
                            imgElement.onload = () => {
                                console.log(`å›¾åƒ ${index + 1} åŠ è½½æˆåŠŸ`);
                            };
                            
                            // æ·»åŠ å›¾åƒåŠ è½½é”™è¯¯å¤„ç†
                            imgElement.onerror = () => {
                                console.error(`å›¾åƒ ${index + 1} åŠ è½½å¤±è´¥: ${imageUrl}`);
                                imgElement.style.display = 'none';
                                const errorMsg = document.createElement('div');
                                errorMsg.textContent = `å›¾åƒ ${index + 1} åŠ è½½å¤±è´¥`;
                                errorMsg.style.color = '#ef4444';
                                errorMsg.style.padding = '15px';
                                errorMsg.style.backgroundColor = '#fef2f2';
                                errorMsg.style.borderRadius = '8px';
                                errorMsg.style.border = '1px solid #fee2e2';
                                errorMsg.style.margin = '10px';
                                errorMsg.style.fontWeight = '500';
                                imageContainer.appendChild(errorMsg);
                            };
                            
                            // å°†å›¾åƒæ·»åŠ åˆ°å®¹å™¨ä¸­
                            imageContainer.appendChild(imgElement);
                        });
                    } else if (imageUrls) {
                        // å¦‚æœä¸æ˜¯æ•°ç»„ä½†æœ‰å€¼ï¼Œæ˜¾ç¤ºå•å¼ å›¾ç‰‡
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrls;
                        imgElement.alt = 'ç”Ÿæˆå›¾åƒ';
                        imgElement.style.maxWidth = '100%';
                        imgElement.style.height = 'auto';
                        imgElement.style.margin = '10px';
                        imgElement.style.borderRadius = '8px';
                        imgElement.style.display = 'block'; // ç¡®ä¿å›¾åƒæ˜¾ç¤º
                        imgElement.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                        imgElement.style.transition = 'transform 0.3s ease';
                        
                        // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                        imgElement.onmouseover = () => {
                            imgElement.style.transform = 'scale(1.02)';
                        };
                        imgElement.onmouseout = () => {
                            imgElement.style.transform = 'scale(1)';
                        };
                        
                        // æ·»åŠ å›¾åƒåŠ è½½äº‹ä»¶å¤„ç†
                        imgElement.onload = () => {
                            console.log('å•å¼ å›¾åƒåŠ è½½æˆåŠŸ');
                        };
                        
                        // æ·»åŠ å›¾åƒåŠ è½½é”™è¯¯å¤„ç†
                        imgElement.onerror = () => {
                            console.error(`å›¾åƒåŠ è½½å¤±è´¥: ${imageUrls}`);
                            imgElement.style.display = 'none';
                            const errorMsg = document.createElement('div');
                            errorMsg.textContent = 'å›¾åƒåŠ è½½å¤±è´¥';
                            errorMsg.style.color = '#ef4444';
                            errorMsg.style.padding = '15px';
                            errorMsg.style.backgroundColor = '#fef2f2';
                            errorMsg.style.borderRadius = '8px';
                            errorMsg.style.border = '1px solid #fee2e2';
                            errorMsg.style.margin = '10px';
                            errorMsg.style.fontWeight = '500';
                            imageContainer.appendChild(errorMsg);
                        };
                        
                        imageContainer.appendChild(imgElement);
                    }
                    
                    // æ˜¾ç¤ºå›¾åƒä¿¡æ¯
                    const timestamp = new Date().toLocaleString();
                    document.getElementById('image-info-content').textContent = 
                        `ç”Ÿæˆæ—¶é—´: ${timestamp}\nä»»åŠ¡ID: ${taskId||""}\nå›¾åƒæ•°é‡: ${Array.isArray(imageUrls) ? imageUrls.length : 1}`;
                    
                    document.getElementById('generate-btn').disabled = false;
                    document.getElementById('cancel-btn').disabled = true;
                },
                onError: (error) => {
                    console.error(`å‘ç”Ÿé”™è¯¯: ${error.message}`);
                    document.getElementById('status-display').textContent = `é”™è¯¯: ${error.message}`;
                    document.getElementById('generate-btn').disabled = false;
                    document.getElementById('cancel-btn').disabled = true;
                }
            });
            
            // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('test-btn').addEventListener('click', async () => {
                ComfyUI.getTaskResult('5cbc125f-24c4-45a8-9df8-82e56340ac8c');
            });
            document.getElementById('cancel-btn').addEventListener('click', async () => {
                
                const cancelled = await ComfyUI.cancelTask();
                if (cancelled) {
                    document.getElementById('status-display').textContent = 'ä»»åŠ¡å·²å–æ¶ˆ';
                    document.getElementById('generate-btn').disabled = false;
                    document.getElementById('cancel-btn').disabled = true;
                }
            });
            
            // ç»‘å®šç”ŸæˆæŒ‰é’®äº‹ä»¶
            document.getElementById('generate-btn').addEventListener('click', async () => {
                document.getElementById('generate-btn').disabled = true;
                document.getElementById('cancel-btn').disabled = false;
                document.getElementById('result-image').style.display = 'none';
                document.getElementById('no-image-text').style.display = 'block';
                document.getElementById('no-image-text').textContent = 'æ­£åœ¨ç”Ÿæˆå›¾åƒ...';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('image-info-content').textContent = '';
                
                // æ¸…ç©ºç°æœ‰å›¾åƒå®¹å™¨
                const imageContainer = document.getElementById('image-container');
                if (imageContainer) {
                    imageContainer.innerHTML = '';
                    console.log('å·²æ¸…ç©ºå›¾åƒå®¹å™¨ï¼Œå‡†å¤‡æ–°çš„ç”Ÿæˆä»»åŠ¡');
                }
                
                try {
                    // è·å–è¡¨å•æ•°æ®
                    const workflowId = document.getElementById('workflow').value||"";
                    if (!workflowId) {
                        throw new Error('è¯·é€‰æ‹©ä¸€ä¸ªæµç¨‹');
                    }
                    
                    const formData = {
                        workflow_id: workflowId,
                        prompt: document.getElementById('prompt').value.trim(),
                        negative_prompt: document.getElementById('negative-prompt').value.trim(),
                        width: parseInt(document.getElementById('width').value),
                        height: parseInt(document.getElementById('height').value),
                        batch_size: parseInt(document.getElementById('batch_size').value),
                    };
                    
                    // è°ƒç”¨ API ç”Ÿæˆå›¾åƒ
                    // const taskData = await ComfyUI.generateImage(formData);
                    document.getElementById('status-display').textContent = `ä»»åŠ¡å·²æäº¤ï¼ŒID: ${taskData.task_id}`;
                } catch (error) {
                    document.getElementById('status-display').textContent = `é”™è¯¯: ${error.message}`;
                    document.getElementById('generate-btn').disabled = false;
                    document.getElementById('cancel-btn').disabled = true;
                }
            });
        });
    </script>
    
    <footer style="text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid var(--border-color); color: #6b7280; font-size: 0.9rem;">
        <p>ComfyUI API é›†æˆç¤ºä¾‹ | 
            <a href="/docs" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;"> æ–‡æ¡£</a> | 
            <a href="https://github.com/rachelos/comfyapi" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Github</a></p>
    </footer>
</body>
</html>